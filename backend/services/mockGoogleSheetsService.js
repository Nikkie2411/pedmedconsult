// Mock Google Sheets Service for development/testing
class MockGoogleSheetsService {
    constructor() {
        this.mockData = {
            patients: [
                { id: 1, patientCode: 'BN001', patientName: 'Nguy·ªÖn VƒÉn A', dateOfBirth: '2020-01-15', gender: 'Nam', weight: 15, height: 100, department: 'Nhi khoa', ward: 'A1', bedNumber: '01', diagnosis: 'Nhi·ªÖm khu·∫©n', allergies: 'Kh√¥ng', createdDate: '2025-08-24', createdBy: 'BS. Nguy·ªÖn' },
                { id: 2, patientCode: 'BN002', patientName: 'Tr·∫ßn Th·ªã B', dateOfBirth: '2019-05-20', gender: 'N·ªØ', weight: 18, height: 105, department: 'Nhi khoa', ward: 'A2', bedNumber: '02', diagnosis: 'Vi√™m ph·ªïi', allergies: 'Penicillin', createdDate: '2025-08-24', createdBy: 'BS. Tr·∫ßn' },
                { id: 3, patientCode: 'BN003', patientName: 'L√™ VƒÉn C', dateOfBirth: '2022-03-10', gender: 'Nam', weight: 12, height: 95, department: 'Nhi khoa', ward: 'B1', bedNumber: '03', diagnosis: 'Suy tim', allergies: 'Kh√¥ng', createdDate: '2025-08-24', createdBy: 'BS. L√™' }
            ],
            requests: [
                { id: 1, patientId: 1, patientCode: 'BN001', patientName: 'Nguy·ªÖn VƒÉn A', drugName: 'Vancomycin', indication: 'Nhi·ªÖm khu·∫©n n·∫∑ng', dosage: '15mg/kg', frequency: '12h', route: 'IV', startDate: '2025-08-23', samplingDate: '2025-08-24', samplingTime: '08:00', lastDoseTime: '20:00', renalFunction: 'B√¨nh th∆∞·ªùng', hepaticFunction: 'B√¨nh th∆∞·ªùng', comorbidities: 'Kh√¥ng', concomitantMeds: 'Kh√¥ng', clinicalQuestion: 'ƒêi·ªÅu ch·ªânh li·ªÅu duy tr√¨', requestingDoctor: 'BS. Nguy·ªÖn VƒÉn D', doctorEmail: 'doctor1@hospital.com', doctorPhone: '0912345678', department: 'Nhi khoa', status: 'Ch·ªù tr·∫£ l·ªùi', assignedPharmacist: 'DS. Nguy·ªÖn VƒÉn X', pharmacistResponse: '', responseDate: '', responseBy: '', priority: 'C·∫•p', createdDate: '2025-08-24', updatedDate: '2025-08-24' },
                { id: 2, patientId: 2, patientCode: 'BN002', patientName: 'Tr·∫ßn Th·ªã B', drugName: 'Digoxin', indication: 'Suy tim', dosage: '5mcg/kg', frequency: '24h', route: 'PO', startDate: '2025-08-22', samplingDate: '2025-08-24', samplingTime: '06:00', lastDoseTime: '06:00', renalFunction: 'Gi·∫£m nh·∫π', hepaticFunction: 'B√¨nh th∆∞·ªùng', comorbidities: 'Suy tim', concomitantMeds: 'Furosemide', clinicalQuestion: 'ƒê√°nh gi√° n·ªìng ƒë·ªô duy tr√¨', requestingDoctor: 'BS. Tr·∫ßn Th·ªã E', doctorEmail: 'doctor2@hospital.com', doctorPhone: '0987654321', department: 'Nhi khoa', status: 'ƒê√£ tr·∫£ l·ªùi', assignedPharmacist: 'DS. Tr·∫ßn Th·ªã Y', pharmacistResponse: 'N·ªìng ƒë·ªô trong kho·∫£ng ƒëi·ªÅu tr·ªã. Ti·∫øp t·ª•c li·ªÅu hi·ªán t·∫°i. Theo d√µi ch·ª©c nƒÉng th·∫≠n.', responseDate: '2025-08-24', responseBy: 'DS. Tr·∫ßn Th·ªã Y', priority: 'Th∆∞·ªùng', createdDate: '2025-08-23', updatedDate: '2025-08-24' }
            ],
            pharmacists: [
                { id: 1, email: 'duocsi1@hospital.com', fullName: 'D∆∞·ª£c sƒ© Nguy·ªÖn VƒÉn X', department: 'Nhi khoa', specialization: 'TDM Nhi', phoneNumber: '0901234567', workSchedule: 'T2-T6: 7h-16h', maxCaseLoad: 10, currentCaseLoad: 3, expertise: 'Vancomycin, Digoxin', isAvailable: true, priority: 1, lastAssigned: '2025-08-24 08:00', createdDate: '2025-08-20' },
                { id: 2, email: 'duocsi2@hospital.com', fullName: 'D∆∞·ª£c sƒ© Tr·∫ßn Th·ªã Y', department: 'Tim m·∫°ch', specialization: 'TDM Tim m·∫°ch', phoneNumber: '0907654321', workSchedule: 'T2-T6: 8h-17h', maxCaseLoad: 8, currentCaseLoad: 2, expertise: 'Digoxin, Warfarin', isAvailable: true, priority: 2, lastAssigned: '2025-08-24 09:00', createdDate: '2025-08-20' }
            ],
            users: [
                // B√°c sƒ© - t√†i kho·∫£n chung theo khoa
                { 
                    username: 'sicu', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // sicu123
                    role: 'doctor', 
                    department: 'SICU', 
                    fullName: 'B√°c sƒ© SICU', 
                    email: 'sicu@hospital.com', 
                    phone: '0901234567', 
                    status: 'active' 
                },
                { 
                    username: 'nhi', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // nhi123
                    role: 'doctor', 
                    department: 'Nhi khoa', 
                    fullName: 'B√°c sƒ© Nhi khoa', 
                    email: 'nhi@hospital.com', 
                    phone: '0901234568', 
                    status: 'active' 
                },
                { 
                    username: 'timMach', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // timMach123
                    role: 'doctor', 
                    department: 'Tim M·∫°ch', 
                    fullName: 'B√°c sƒ© Tim M·∫°ch', 
                    email: 'timmach@hospital.com', 
                    phone: '0901234569', 
                    status: 'active' 
                },
                // D∆∞·ª£c sƒ© - t√†i kho·∫£n ri√™ng
                { 
                    username: 'duocSi1', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // duocSi123
                    role: 'pharmacist', 
                    department: 'D∆∞·ª£c', 
                    fullName: 'DS. Nguy·ªÖn VƒÉn A', 
                    email: 'duocsi1@hospital.com', 
                    phone: '0901234570', 
                    status: 'active' 
                },
                { 
                    username: 'duocSi2', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // duocSi456  
                    role: 'pharmacist', 
                    department: 'D∆∞·ª£c', 
                    fullName: 'DS. Tr·∫ßn Th·ªã B', 
                    email: 'duocsi2@hospital.com', 
                    phone: '0901234571', 
                    status: 'active' 
                },
                { 
                    username: 'duocSi3', 
                    password: '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // duocSi789
                    role: 'pharmacist', 
                    department: 'D∆∞·ª£c', 
                    fullName: 'DS. L√™ VƒÉn C', 
                    email: 'duocsi3@hospital.com', 
                    phone: '0901234572', 
                    status: 'active' 
                }
            ]
        };
        this.nextIds = {
            patients: 4,
            requests: 3,
            pharmacists: 3,
            users: 4
        };
    }

    async initialize() {
        console.log('üîß Mock Google Sheets Service initialized');
        return true;
    }

    async ensureInitialized() {
        // Mock service is always initialized
        return true;
    }

    // PATIENTS Operations
    async createPatient(patientData) {
        const newPatient = {
            id: this.nextIds.patients++,
            ...patientData,
            createdDate: new Date().toISOString().split('T')[0]
        };
        this.mockData.patients.push(newPatient);
        console.log('üìù Mock: Created patient', newPatient.patientCode);
        return newPatient;
    }

    async getPatients(department = null) {
        let patients = [...this.mockData.patients];
        if (department) {
            patients = patients.filter(p => p.department === department);
        }
        console.log(`üìã Mock: Retrieved ${patients.length} patients`);
        return patients;
    }

    // REQUESTS Operations
    async createRequest(requestData) {
        const newRequest = {
            id: this.nextIds.requests++,
            ...requestData,
            status: 'Ch·ªù tr·∫£ l·ªùi',
            pharmacistResponse: '',
            responseDate: '',
            responseBy: '',
            priority: requestData.priority || 'Th∆∞·ªùng',
            createdDate: new Date().toISOString().split('T')[0],
            updatedDate: new Date().toISOString().split('T')[0]
        };
        this.mockData.requests.push(newRequest);
        console.log('üìù Mock: Created request', newRequest.id, 'for drug', newRequest.drugName);
        return newRequest;
    }

    async getRequests(filters = {}) {
        let requests = [...this.mockData.requests];
        
        if (filters.status) {
            requests = requests.filter(r => r.status === filters.status);
        }
        if (filters.department) {
            requests = requests.filter(r => r.department === filters.department);
        }
        if (filters.assignedPharmacist) {
            requests = requests.filter(r => r.assignedPharmacist === filters.assignedPharmacist);
        }
        
        console.log(`üìã Mock: Retrieved ${requests.length} requests with filters:`, filters);
        return requests;
    }

    async updateRequestResponse(requestId, response, pharmacistName) {
        const requestIndex = this.mockData.requests.findIndex(r => r.id == requestId);
        if (requestIndex === -1) {
            throw new Error(`Request with ID ${requestId} not found`);
        }

        this.mockData.requests[requestIndex] = {
            ...this.mockData.requests[requestIndex],
            status: 'ƒê√£ tr·∫£ l·ªùi',
            pharmacistResponse: response,
            responseDate: new Date().toISOString().split('T')[0],
            responseBy: pharmacistName,
            updatedDate: new Date().toISOString().split('T')[0]
        };

        console.log('‚úÖ Mock: Updated request', requestId, 'response by', pharmacistName);
        return {
            success: true,
            requestId,
            response,
            pharmacistName,
            responseDate: new Date().toISOString().split('T')[0]
        };
    }

    // PHARMACISTS Operations
    async getPharmacists(filters = {}) {
        let pharmacists = [...this.mockData.pharmacists];
        
        if (filters.department) {
            pharmacists = pharmacists.filter(p => p.department === filters.department);
        }
        if (filters.isAvailable !== undefined) {
            pharmacists = pharmacists.filter(p => p.isAvailable === filters.isAvailable);
        }
        if (filters.drugName) {
            pharmacists = pharmacists.filter(p => 
                p.expertise.toLowerCase().includes(filters.drugName.toLowerCase())
            );
        }
        
        console.log(`üë• Mock: Retrieved ${pharmacists.length} pharmacists with filters:`, filters);
        return pharmacists;
    }

    // Users Operations
    async getUserByUsername(username) {
        const user = this.mockData.users.find(u => u.username === username && u.status === 'active');
        if (user) {
            console.log(`üë§ Mock: Found user ${username} (${user.role})`);
            return user;
        }
        console.log(`‚ùå Mock: User ${username} not found`);
        return null;
    }

    async getAllUsers() {
        console.log(`üë• Mock: Retrieved ${this.mockData.users.length} users`);
        return this.mockData.users;
    }

    // Health check
    async healthCheck() {
        return {
            status: 'OK',
            mode: 'MOCK',
            sheetsConnected: 6,
            totalSheets: 6,
            spreadsheetTitle: 'Mock PedMedConsult Database',
            recordCounts: {
                patients: this.mockData.patients.length,
                requests: this.mockData.requests.length,
                pharmacists: this.mockData.pharmacists.length,
                users: this.mockData.users.length
            }
        };
    }
}

module.exports = MockGoogleSheetsService;
